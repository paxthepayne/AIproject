# Smart Crowd Router

**Intelligent pedestrian navigation for Barcelona using Reinforcement Learning**

> Project by: Filippo Pacini, Jacopo Crispolti, Liseth Berdeja, Sieun You

---

## Overview

Smart Crowd Router is a pedestrian navigation system that computes optimal routes through Barcelona, accounting for **real-time crowd density**. Unlike traditional routing systems that only minimize distance, this project uses a **Q-Learning agent** to balance two objectives:

1. **Minimize distance** to the destination
2. **Avoid crowded areas** based on historical data and current conditions

The system always compares the suggested route with the shortest path, allowing users to evaluate the trade-off between distance and comfort.

---

## System Architecture

```
┌─────────────────────────────────────────────────────┐
│                     DATA SOURCES                    │
├─────────────────┬─────────────────┬─────────────────┤
│  OpenData BCN   │  Google Maps    │ OpenStreetMap   │
│  (city POIs)    │  (popularTimes) │ (street graph)  │
└────────┬────────┴────────┬────────┴────────┬────────┘
         │                 │                 │
         └─────────────────┼─────────────────┘
                           ▼
               ┌───────────────────────┐
               │    run map_builder    │
               │    (map.json.gz)      │
               └───────────┬───────────┘
                           ▼
               ┌─────────────────────┬────────────────────────────┐
               │  main.py            │ tools.py                   │
               │  (user interaction) │ (weather, pathfinding, ..) │
               └─────────────────────┴────────────────────────────┘
                          
```

---

## File Structure

| File | Description |
|------|-------------|
| `main.py` | Main script: loads data, handles user interaction, runs pathfinding |
| `tools.py` | Utilities: weather, place search, distance calculation, Q-Learning algorithm |
| `map_builder.py` | Builds the city graph by combining POIs, crowd data, and street network |
| `map.json.gz` | Pre-computed city graph (generated by `map_builder.py`) |

---

## How It Works

### Map Construction (One-time Setup)

`map_builder.py` creates the city graph:

1. **Downloads POIs** from OpenData BCN (~900 points of interest)
2. **Enriches with Google PopularTimes**: for each POI, finds historical hourly crowd data 
3. **Builds the street network** from OpenStreetMap using OSMnx python library
4. **Links POIs to streets**: each point of interest is associated with the nearest street segment
5. **Aggregates data**: POI crowd levels are propagated to their host streets
6. **Exports** the graph as a compressed JSON file

**Node Structure:**
```json
{
  "id": 12345,
  "type": 0, // 0 = street, 1 = place
  "name": "Carrer de Balmes",
  "coords": [41.3951, 2.1534],
  "len": 125.4, // length in meters
  "conns": [12344, 12346, 50023], // connected nodes
  "popular_times": [[...], [...], ...]  // 7x24 matrix
}
```

### Real-time Crowd Adjustments

At startup, `main.py`:

- Fetches **current weather conditions** from Open-Meteo API (Simplified to Sunny/Cloudy/Rainy)
- Determines **current day and hour**
- Computes each street's crowd level using:

```
crowd = popular_times[day][hour] × weather_modifier
```

| Weather | Modifier |
|---------|----------|
| Sunny | ×1.3 |
| Cloudy | ×0.9 |
| Rainy | ×0.3 |

### Q-Learning Algorithm

The agent learns the optimal path through trial-and-error:

**Reinforcement Learning Components:**

| Element | Description |
|---------|-------------|
| **State** | Current node in the graph (street or POI) |
| **Action** | Move to a connected node |
| **Reward** | Function balancing distance and crowd exposure |

**Reward Function:**
```python
reward = -1                           # Base penalty per step
reward += 10000 if goal_reached       # Arrival bonus
reward += 1 if getting_closer         # Direction bonus
reward -= node_crowd_level            # Crowd penalty
```

**Hyperparameters:**
- Learning rate (α): 0.5 with 0.9992 decay
- Discount factor (γ): 1.0
- Exploration rate (ε): 1.0 with 0.999 decay
- Max episodes: 5000
- Early stopping: convergence if ΔQ < 0.01 for 5 consecutive episodes

### Results and Comparisons

The optimal path gets compared to the shortest possible path found (calculated using an A* algorithm); 
The user can see metrics (path length, average crowd exposure) and a quick overview of the steps to the goal for both options.

### Smart Navigation Mode

Smart Navigation Mode allows users to interact directly with the learned Q-learning policy. At every step, the system suggests route options ranked from best to worst, while still giving the user full freedom to override the recommendation and explore alternative paths.

---

## Usage

**Example of an Output:**
```
[AI Project - Smart Crowd Router] By Filippo Pacini, Jacopo Crispolti, Liseth Berdeja, Sieun You

Fetching weather info...
> Monday 14:30, Sunny

Enter your location: Sagrada Familia
> Best match: Basílica de la Sagrada Família [Place]

Enter destination (<3km distance): Parc Guell
> Best match: Park Güell [Place]

[Q-Learning] from 'Basílica de la Sagrada Família' to 'Park Güell'
· Episode 10: 245 steps, Δ = 1.2340
· Episode 50: 89 steps, Δ = 0.3421
-> Values converged at episode 127 (max Δ = 0.01, patience = 5)

[Suggested path] 2340 meters | 12.45 average crowd exposure
Sagrada Família -> Carrer de Provença -> Carrer de Sardenya -> ...

[Shortest path] 1890 meters | 28.73 average crowd exposure
Sagrada Família -> Avinguda de Gaudí -> Travessera de Gràcia -> ...
```

---

## Project Contribution

Person   |	Area   | %
---------|---------|----
Person A | Map construction & data integration (OpenData BCN, OSM, Google PopularTimes, aggregation logic) |	30%
Person B | Routing algorithms (Q-learning design, reward function, training logic, A*, tuning) | 30%
Person C | System integration & interaction (main.py, navigation mode, UX, weather integration, evaluation metrics) |	20%
Person D | Documentation & presentation (PDF writing, diagrams, results analysis, conclusions, slides) | 20%