# Smart Crowd Router

**Intelligent pedestrian navigation for Barcelona using Reinforcement Learning**

> Project by: Filippo Pacini, Jacopo Crispolti, Liseth Berdeja, Sieun You

---

## Overview

Smart Crowd Router is a pedestrian navigation system that computes optimal routes through Barcelona, accounting for **real-time crowd density**. Unlike traditional routing systems that only minimize distance, this project uses a **Q-Learning agent** to balance two objectives:

1. **Minimize distance** to the destination
2. **Avoid crowded areas** based on historical data and current conditions

The system always compares the suggested route with the shortest path, allowing users to evaluate the trade-off between distance and comfort.

---

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATA SOURCES                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  OpenData BCN   â”‚  Google Maps    â”‚ OpenStreetMap   â”‚
â”‚  (city POIs)    â”‚  (popularTimes) â”‚ (street graph)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    run map_builder    â”‚
               â”‚    (map.json.gz)      â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  main.py            â”‚ tools.py                   â”‚
               â”‚  (user interaction) â”‚ (weather, pathfinding, ..) â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          
```

---

## File Structure

| File | Description |
|------|-------------|
| `main.py` | Main script: loads data, handles user interaction, runs pathfinding |
| `tools.py` | Utilities: weather, place search, distance calculation, Q-Learning algorithm |
| `map_builder.py` | Builds the city graph by combining POIs, crowd data, and street network |
| `map.json.gz` | Pre-computed city graph (generated by `map_builder.py`) |

---

## How It Works

### Map Construction (One-time Setup)

`map_builder.py` creates the city graph:

1. **Downloads POIs** from OpenData BCN (~900 points of interest)
2. **Enriches with Google PopularTimes**: for each POI, finds historical hourly crowd data 
3. **Builds the street network** from OpenStreetMap using OSMnx python library
4. **Links POIs to streets**: each point of interest is associated with the nearest street segment
5. **Aggregates data**: POI crowd levels are propagated to their host streets
6. **Exports** the graph as a compressed JSON file

**Node Structure:**
```json
{
  "id": 12345,
  "type": 0, // 0 = street, 1 = place
  "name": "Carrer de Balmes",
  "coords": [41.3951, 2.1534],
  "len": 125.4, // length in meters
  "conns": [12344, 12346, 50023], // connected nodes
  "popular_times": [[...], [...], ...]  // 7x24 matrix
}
```

### Real-time Crowd Adjustments

At startup, `main.py`:

- Fetches **current weather conditions** from Open-Meteo API (Simplified to Sunny/Cloudy/Rainy)
- Determines **current day and hour**
- Computes each street's crowd level using:

```
crowd = popular_times[day][hour] Ã— weather_modifier
```

| Weather | Modifier |
|---------|----------|
| Sunny | Ã—1.3 |
| Cloudy | Ã—0.9 |
| Rainy | Ã—0.3 |

### Q-Learning Algorithm

The agent learns the optimal path through trial-and-error:

**Reinforcement Learning Components:**

| Element | Description |
|---------|-------------|
| **State** | Current node in the graph (street or POI) |
| **Action** | Move to a connected node |
| **Reward** | Function balancing distance and crowd exposure |

**Reward Function:**
```python
reward = -1                           # Base penalty per step
reward += 10000 if goal_reached       # Arrival bonus
reward += 1 if getting_closer         # Direction bonus
reward -= node_crowd_level            # Crowd penalty
```

**Hyperparameters:**
- Learning rate (Î±): 0.5 with 0.9992 decay
- Discount factor (Î³): 1.0
- Exploration rate (Îµ): 1.0 with 0.999 decay
- Max episodes: 5000
- Early stopping: convergence if Î”Q < 0.01 for 5 consecutive episodes

### Results and Comparisons

The optimal path gets compared to the shortest possible path found (calculated using an A* algorithm);
The compared metrics are path length and average crowd exposure.
---

## ğŸš€ Installation

### Prerequisites

- Python 3.8+
- Google Maps API Key (for PopularTimes and Weather)

### Dependencies

```bash
pip install pandas geopandas numpy matplotlib requests
pip install osmnx googlemaps populartimes
```

### Setup

1. Clone the repository
2. Add your Google API Key to `map_builder.py` and `tools.py`
3. If `map.json.gz` doesn't exist, run `map_builder.py` first

---

## ğŸ’» Usage

```bash
python main.py
```

**Expected Output:**
```
[AI Project - Smart Crowd Router] By Filippo Pacini, Jacopo Crispolti, Liseth Berdeja, Sieun You

Fetching weather info...
> Monday 14:30, Sunny

Enter your location: Sagrada Familia
> Best match: BasÃ­lica de la Sagrada FamÃ­lia [Place]

Enter destination (<2km distance): Parc Guell
> Best match: Park GÃ¼ell [Place]

[Q-Learning] from 'BasÃ­lica de la Sagrada FamÃ­lia' to 'Park GÃ¼ell'
Â· Episode 10: 245 steps, Î” = 1.2340
Â· Episode 50: 89 steps, Î” = 0.3421
-> Values converged at episode 127 (max Î” = 0.01, patience = 5)

[Suggested path] 2340 meters | 12.45 average crowd exposure
Sagrada FamÃ­lia -> Carrer de ProvenÃ§a -> Carrer de Sardenya -> ...

[Shortest path] 1890 meters | 28.73 average crowd exposure
Sagrada FamÃ­lia -> Avinguda de GaudÃ­ -> Travessera de GrÃ cia -> ...
```

---

## ğŸ“Š Output

The system provides two routes:

| Metric | Suggested Path | Shortest Path |
|--------|----------------|---------------|
| **Optimizes** | Low crowd exposure | Minimum distance |
| **Distance** | Potentially longer | Minimum |
| **Crowd exposure** | Minimized | Not considered |

Users can choose based on their priorities: getting there quickly or walking in peace.

---

## ğŸ”® Future Extensions

- [ ] Web-based GUI with interactive map
- [ ] Real-time traffic data integration
- [ ] Support for other cities
- [ ] Mobile app with turn-by-turn navigation
- [ ] Special events consideration (concerts, matches, demonstrations)
- [ ] User preferences (avoid stairs, prefer green areas, etc.)

---

## ğŸ“„ License

Academic project - All rights reserved by the authors.

---

## ğŸ™ Acknowledgments

- [OpenData BCN](https://opendata-ajuntament.barcelona.cat/) for point-of-interest data
- [OpenStreetMap](https://www.openstreetmap.org/) for the street network
- [Google Maps Platform](https://developers.google.com/maps) for crowd and weather data
